name: CI

on:
  pull_request:
    branches: [main]
  workflow_call:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'viewer/package-lock.json'
      - name: Install dependencies
        working-directory: viewer
        run: npm ci
      - name: Run ESLint
        working-directory: viewer
        run: npm run lint

  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for Python changes
        id: python-changes
        run: |
          # For PRs, check if Python files changed vs main
          # For workflow_call (deploy), always run Ruff
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if git diff --name-only origin/main...HEAD 2>/dev/null | grep -q '\.py$'; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            # For workflow_call or other triggers, always run Ruff
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      - uses: actions/setup-python@v5
        if: steps.python-changes.outputs.has_changes == 'true'
        with:
          python-version: '3.10'
      - name: Install Ruff
        if: steps.python-changes.outputs.has_changes == 'true'
        run: pip install ruff
      - name: Run Ruff (lint check)
        if: steps.python-changes.outputs.has_changes == 'true'
        working-directory: plugin
        run: ruff check .
      - name: Run Ruff (format check)
        if: steps.python-changes.outputs.has_changes == 'true'
        working-directory: plugin
        run: ruff format --check .
      - name: Skip Ruff (no Python changes)
        if: steps.python-changes.outputs.has_changes == 'false'
        run: echo "No Python files changed, skipping Ruff checks"

  type-check:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'viewer/package-lock.json'
      - name: Install dependencies
        working-directory: viewer
        run: npm ci
      - name: TypeScript type check
        working-directory: viewer
        run: npx tsc --noEmit

  test:
    runs-on: ubuntu-latest
    needs: type-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'viewer/package-lock.json'
      - name: Install dependencies
        working-directory: viewer
        run: npm ci
      - name: Run tests
        working-directory: viewer
        run: npm run test:run

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'viewer/package-lock.json'
      - name: Install dependencies
        working-directory: viewer
        run: npm ci
      - name: Build
        working-directory: viewer
        run: npm run build
